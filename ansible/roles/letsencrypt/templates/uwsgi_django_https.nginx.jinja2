# {{ ansible_managed }}

# Base Config Generator:
# https://mozilla.github.io/server-side-tls/ssl-config-generator/

upstream django {
  server unix:{{ uwsgi_socket_path }};
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name www.{{ app_domain }};
  charset utf-8;

  ssl_certificate {{ le_fullchain_path }};
  ssl_certificate_key {{ le_privkey_path }};

  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:50m;
  ssl_session_tickets off;

  # OCSP Stapling
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate {{ le_chain_path }};

  # Only use TLS v1.2 as Transport Security Protocol
  ssl_protocols TLSv1.2;

  # Only use ciphersuites that are considered modern and secure by Mozilla
  ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';

  # Do not let attackers downgrade the ciphersuites in Client Hello
  # Always use server-side offered ciphersuites
  ssl_prefer_server_ciphers on;

  # FIXME-dns resolver should be running on localhost
  resolver 208.67.222.222 208.67.220.220;  # OpenDNS servers
  # resolver 8.8.8.8 8.8.4.4;  # Google DNS servers

  access_log {{ nginx_access_log_file }};
  error_log {{ nginx_error_log_file }};

  location /media/ {
    alias {{ django_media_root }}/;
  }

  location /static/ {
    alias {{ django_static_root }}/;
  }

  # Do not cache sw.js, required for offline-first updates.
  location /sw.js {
    add_header Cache-Control "no-cache";
    proxy_cache_bypass $http_pragma;
    proxy_cache_revalidate on;
    expires off;
    access_log off;

    root {{ django_static_root }};
    try_files $uri /sw.js;
  }

  location /api/ {
    uwsgi_pass django;

    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    uwsgi_param  QUERY_STRING       $query_string;
    uwsgi_param  REQUEST_METHOD     $request_method;
    uwsgi_param  CONTENT_TYPE       $content_type;
    uwsgi_param  CONTENT_LENGTH     $content_length;

    uwsgi_param  REQUEST_URI        $request_uri;
    uwsgi_param  PATH_INFO          $document_uri;
    uwsgi_param  DOCUMENT_ROOT      $document_root;
    uwsgi_param  SERVER_PROTOCOL    $server_protocol;
    uwsgi_param  REQUEST_SCHEME     $scheme;
    uwsgi_param  HTTPS              $https if_not_empty;

    uwsgi_param  REMOTE_ADDR        $remote_addr;
    uwsgi_param  REMOTE_PORT        $remote_port;
    uwsgi_param  SERVER_PORT        $server_port;
    uwsgi_param  SERVER_NAME        $server_name;
  }

  # always serve index.html for any other request
  location / {
    root {{ django_static_root }};
    try_files $uri /index.html;
  }
}

{% if app_env == 'prod' %}
# redirect non-www to www
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name {{ app_domain }};

  ssl_certificate {{ le_fullchain_path }};
  ssl_certificate_key {{ le_privkey_path }};

  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:50m;
  ssl_session_tickets off;

  # OCSP Stapling
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate {{ le_chain_path }};

  # Only use TLS v1.2 as Transport Security Protocol
  ssl_protocols TLSv1.2;

  # Only use ciphersuites that are considered modern and secure by Mozilla
  ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';

  # Do not let attackers downgrade the ciphersuites in Client Hello
  # Always use server-side offered ciphersuites
  ssl_prefer_server_ciphers on;

  # FIXME-dns resolver should be running on localhost
  resolver 208.67.222.222 208.67.220.220;  # OpenDNS servers
  # resolver 8.8.8.8 8.8.4.4;  # Google DNS servers

  location / {
    return 301 https://www.{{ app_domain }}$request_uri;
  }
}
{% endif %}

# redirect http to https
server {
  listen 80;
  listen [::]:80;
{% if app_env == 'prod' %}
  server_name {{ app_domain }} www.{{ app_domain }};
{% else %}
  server_name {{ app_domain }};
{% endif %}

  root {{ nginx_sites_dir }};

  # allow letsencrypt challenges over http
  location /.well-known/acme-challenge/ {
    try_files $uri $uri/ =404;
  }

  # redirect everything else to https
  location / {
    return 301 https://$server_name$request_uri;
  }
}
